from cloudrail.knowledge.context.azure.azure_environment_context import AzureEnvironmentContext
from cloudrail.knowledge.context.mergeable import EntityOrigin
from tests.knowledge.context.azure_context_test import AzureContextTest
from tests.knowledge.context.test_context_annotation import context


class TestSqlServerVulnerabilityAssessment(AzureContextTest):

    def get_component(self):
        return "sql_server_vulnerability_assessment"

    @context(module_path="basic")
    def test_basic(self, ctx: AzureEnvironmentContext):
        vulnerability = next((vulnerability for vulnerability in ctx.sql_server_vulnerability_assessments
                             if vulnerability.server_security_alert_policy_id in
                             ('/subscriptions/230613d8-3b34-4790-b650-36f31045f19a/resourceGroups/cr2523-RG/providers/Microsoft.Sql/servers/cr2523-sqlserver/securityAlertPolicies/Default', 'azurerm_mssql_server_security_alert_policy.example.id')), None)
        self.assertIsNotNone(vulnerability)
        self.assertIsNone(vulnerability.storage_container_sas_key)
        self.assertTrue(vulnerability.recurring_scans_settings)
        self.assertTrue(vulnerability.recurring_scans_settings.email_subscription_admins)
        self.assertTrue(vulnerability.recurring_scans_settings.enabled)
        self.assertEqual(vulnerability.recurring_scans_settings.emails, ['email@example1.com', 'email@example2.com'])
        if vulnerability.origin == EntityOrigin.LIVE_ENV:
            self.assertIsNone(vulnerability.storage_account_access_key)
            self.assertEqual(vulnerability.storage_container_path,
                             'https://cr2523tststoracc.blob.core.windows.net/cr2523container/')
        else:
            self.assertEqual(vulnerability.storage_account_access_key, 'azurerm_storage_account.example.primary_access_key')
            self.assertEqual(vulnerability.storage_container_path, 'azurerm_storage_account.example.primary_blob_endpointcr2523container/')
